// Prisma schema for CineWeave

generator client {
  provider             = "prisma-client-py"
  interface            = "asyncio"
  recursive_type_depth = 5
}

datasource db {
  provider = "sqlite"
  url      = "file:./cineweave.db"
}

model User {
  id        String   @id @default(uuid())
  clerkId   String   @unique
  email     String
  plan      String   @default("starter")
  credits   Int      @default(80)
  createdAt DateTime @default(now())

  jobs          Job[]
  creditLedger  CreditLedger[]
}

model Job {
  id           String   @id @default(uuid())
  userId       String
  prompt       String
  imageUrl     String?
  durationSec  Int
  creditsUsed  Int
  status       String   @default("queued") // queued, running, done, failed
  seed         Int?
  cfg          Float    @default(7.5)
  runpodJobId  String?  @unique
  r2Url        String?
  errorMessage String?
  expiresAt    DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([runpodJobId])
}

model CreditLedger {
  id           String   @id @default(uuid())
  userId       String
  amount       Int
  balanceAfter Int
  type         String   // subscription, refund, purchase
  description  String
  jobId        String?
  timestamp    DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
}

model Plan {
  id          String @id @default(uuid())
  name        String @unique
  displayName String
  credits     Int
  price       Int
  features    String // JSON string of features
}
